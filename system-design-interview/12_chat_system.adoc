:toc:

= 12. 채팅 시스템 설계

== 문제 이해 및 설계 범위 확정
* 1:1 & 그룹 (최대 100명) 채팅
* App, Web, 동시 접속 지원
* DAU 5천만
* 사용자 접속상태 표시, 텍스트만 가능, 10만자 이하, permanent 보관, 알림
* 종단 간 암호화 지원은 당장은 필요 없음

== 개략적 설계안 제시 및 동의 구하기
* 메시지 수신, 수신자 결정 및 전달, 수신자가 online 이 아닌 경우 접속할 때까지 메시지 보관

=== 폴링
클라이언트가 주기적으로 서버에게 새 메시지가 있는지 확인

=== 롱 폴링
클라이언트는 새 메시지가 반환되거나 타임아웃 될 때까지 연결 유지

* 송/수신 클라이언트가 같은 채팅 서버에 없을 수 있음 (메시지를 받은 서버가 수신할 클라이언트와의 연결이 없음)
* 서버는 클라이언트가 연결을 끊었는지 알 수 없음

=== WebSocket
* HTTP handshake 수행 후 메시지 양방향 전송
* 송/수신에 동일한 프로토콜을 사용 -> 설계 및 구현이 단순하고 직관적
* 서버 측에서 연결 관리를 효율적으로 해야 함

=== 개략적 설계안
==== stateless service
* 로그인, 회원가입, 사용자 프로필 표시 등 request/response

=== stateful service
* 클라이언트가 채팅 서버와 독립적인 네트워크 연결을 유지해야 함
* service discovery 는 채팅 서비스와 협력하여 특정 서버에 부하가 몰리지 않도록 해야 함

=== third party
* 푸시알림

=== 규모 확장성
* 실시간: 채팅, 접속상태 서버
* API 서버
* 알림 서버
* key-value store: 채팅 이력 보관

==== storage
* RDB? NoSQL? - read/write 연산 패턴을 보자
** 사용자 프로필, 설정, 친구 목록 -> RDB
** 채팅 이력 -> key-value store
*** 특징
**** 채팅 이력 데이터의 양이 많음
**** 가장 빈번하게 사용되는건 최근에 주고받은 메시지
**** 검색, 멘션, 점프 등의 기능
**** 1:1 채팅은 read:write  1:1
*** key-value store 특징
**** horizontal scaling 이 쉬움, 데이터 접근 지연 시간이 낮음
**** RDB 는 long tail 에 해당하는 부분을 잘 처리하지 못하는 경향 (인덱스가 크면 random access)
**** 이미 선행된 서비스들 (Facebook - HBase, Discord - Cassandra)

=== 데이터 모델
* 1:1, group 메시지 테이블 분리
* key-value store 인데 이러면 key 가 의미가 있나?
* Message ID
** 순서를 표현할 수 있어야 함
.. Snowflake 등으로 생성 (앞선 장)
.. local sequence number generator 이용
*** 같은 채널 or 1:1 세션 안에서만 아이디 증분

== 상세 설계

=== Service Discovery
* 클라이언트의 위치, 서버의 용량을 고려한 서버 추천 -> Zookeeper 를 주로 사용
* 로그인 -> API 서버 -> (특정 채팅 서버 반환) -> 클라이언트와 채팅 서버 연결

=== 메시지 흐름
. 사용자 A 가 채팅 서버 1로 메시지 전송
. 채팅 서버 1이 ID 설정 -> 메시지 동기화 큐로 전송
. key-value store 에 저장
. 사용자 B 가 online 인 경우 채팅 서버 2 로 전송, offline 인 경우 푸시 알림 서버로
. 채팅 서버 2가 사용자 B 에 메시지 전송

=== 여러 단말 사이의 메시지 동기화
단말마다 cur_max_message_id 를 가지고, 해당 값보다 큰 메시지 ID 는 가져옴

=== 소규모 그룹 채팅에서의 메시지 흐름
* 사용자 별 큐를 두기 vs 큐는 하나로 두고 메시지를 순서대로 받기

=== 접속상태 표시
==== 사용자 로그인
* status + last_active_at 을 key-value store 에 보관

==== 로그아웃
* status = offline 으로 변경

==== 접속 장애
* 클라이언트 -> 서버로 heartbeat 를 보내서 주기적으로 확인
* 그러면 웹소켓에 대한 heartbeat 가 제대로 왔는지에 대한 배치가 도는건가? 간단한 구현이 없을지

==== 상태 정보의 전송
* 사용자가 그룹 채팅에 입장하는 순간에만 상태 정보를 읽기
* 수동으로 갱신

=== 마무리
* 채팅 앱의 확장 - 사진, 비디오
** 압축 방식, 클라우드 저장소, 썸네일
* https://faq.whatsapp.com/en/android/28030015[종단 간 암호화]
* 캐시 (클라이언트)
* 로딩 속도 개선 - 데이터, 채널을 지역적으로 분산
* 오류 처리
** 서버 오류: 서버 재배정
** 메시지 재전송: retry, queue