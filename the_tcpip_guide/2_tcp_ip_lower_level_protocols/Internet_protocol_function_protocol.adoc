= IP 관련 기능 프로토콜

== 28장. IP 네트워크 주소 변환(NAT) 프로토콜

=== IP NAT 개요

IP 주소 비용 증가, 보안 우려 증가 문제를 해결하기 위한 기술 개발

RFC 1631, "The IP Network Address Translator (NAT)"

==== 장점

* 공인 IP 주소 공유: 대량의 호스트가 소수의 공인 IP 주소 공유
* 쉬운 확장: 로컬 네트워크에 새 장비 추가가 쉬움
* 로컬 통제력 강화
* ISP 선택의 유연성: 공인 주소만 변경하면 됨
* 보안 강화, 투명함

==== 단점

* 복잡성
* (클라이언트) 공인 주소 부족으로 인한 문제
* 특정 애플리케이션과의 호환성 문제: FTP 등
* 보안 프로토콜 문제
* 클라이언트 접근 지원 미비
* 성능 감소: 주소 변환, 헤더 체크섬 재계산

=== IP NAT 주소 용어

* 내부 (inside) 주소: 로컬 네트워크의 장비를 가리키는 모든 주소
* 외부 (outside) 주소: 공중 인터넷에 있는 장비를 가리키는 주소
* 로컬 주소: 내부/외부 관계 없이 내부 네트워크의 데이터그램에 나타나는 주소
* 전역 주소: 내부/외부 관계 없이 외부 네트워크의 데이터그램에 나타나는 주소

종합

* 내부 로컬 주소: 로컬 네트워크의 장비 주소
* 내부 전역 주소: 내부 장비를 외부에 표현하는 데 쓰이는 주소
** 서버가 응답을 보낼 때 목적지 주소로 사용할 수 있음
** 일부 상황에서 내부 로컬 주소와 외부 로컬 주소가 동일할 수 있다 (사설 - 사설로 연결된 경우)
* 외부 전역 주소: 인터넷 서버의 외부 전역 주소, 공인 IP
* 외부 로컬 주소: 로컬 네트워크에서 참조하는 외부 장비의 주소

=== 정적 주소 매핑과 동적 주소 매핑

NAT 소프트웨어는 변환 테이블을 관리해야 한다 +
내부 로컬 주소 -> 내부 전역 주소로 매핑하는 정보 포함

==== 정적 매핑

* 장비의 전역 표현과 로컬 표현 사이에 정의된 영구적이고 고정된 관계

==== 동적 매핑

* NAT 라우터에서 필요할 때마다 즉시 생성, 사용이 끝나면 버려짐
* 내부 장비가 내부 전역 주소 풀을 이용할 때

==== 선택

* 정적 매핑: 항상 동일한 공인 주소로 표현되어야 할 장비에 적합
** 특정 장비로의 인바운드 트래픽을 허용하는 데에 쓰일 수도
** 단점: 수동 매핑 정보 입력, 관리. 내부 네트워크에서 IP 공유를 허용하지 않음
* 동적 매핑: 공인 IP 주소 공유를 촉진하기 위해 쓰임
* 모두 사용도 가능
** 특정 장비는 정적, 나머지는 동적
* 동적 매핑의 또다른 방법은 DNS 의 도메인 주소 결정을 사용할 수 있다

=== IP NAT 단방향 (전통적/아웃바운드) 동작

* 최초의 NAT
* 내부에서 외부로 송신되는 데이터그램으로 통신이 시작된다는 가정
** 단방향 (Unidirectional) or outbound NAT
* 순서: p436 그림
** 로컬 장비 -> (출발지/목적지) -> NAT -> (변경 출발지/목적지) -> 서버 -> (목적지/변경 출발지) -> NAT -> (목적지/출발지) -> 로컬 장비
* 하나 이상의 라우터가 존재할 수 있음. 이 경우 라우터들이 동일한 변환 테이블을 사용해야 함

=== IP NAT 양방향 (Two-Way/인바운드) 동작

* directional or inbound
* 전통적 NAT 와, 외부 네트워크에서 시작된 트랜잭션을 모두 처리할 수 있음
* 외부 네트워크의 장비가 내부 네트워크로 보내는 방법 2가지
.. 외부에서 접근해야 하는 내부 네트워크의 서버를 정적 매핑
.. DNS 와 NAT 통합 사용
* 내부 네트워크의 장비가 외부 장비에게 알려지면 트랜잭션이 시작될 수 있다
* 순서: p438 그림, 위와 차이는 양방향만 있음

=== IP NAT 포트 기반 (과부하) 동작

* port-based or overloaded
* 20개의 호스트가 트랜잭션을 진행중일 때 21번째 호스트가 인터넷에 접근을 시도하려 한다면? - 불가능
** 해결하기 위해 상위 계층의 포트를 추가로 사용
* TCP, UDP 의 포트 번호까지 변경
* 포트 번호가 없다면 포트 변환은 수행될 수 없고, PAT 는 제대로 동작하지 않는다

=== IP NAT 중복/2회 NAT 동작

* overlapping or twice
* 내부 네트워크에서 사용하는 주소와 외부 네트워크에서 사용하는 주소가 겹칠 경우, 기존 NAT 로는 어렵다
** 사설 네트워크와 사설 네트워크 간의 연결
** 사설 네트워크에 공인 주소를 부적절하게 할당
** 공인 주소 할당의 유효 기간 만료
* 좀 더 복잡한 형태의 NAT 사용 - 출발지 주소와 목적지 주소를 모두 변경
* 사설 네트워크 + 내부 네트워크 주소 공간과 충돌되는 중복 네트워크를 위한 매핑 생성
** 중복되는 네트워크에 보내는 데이터그램을 유일하게 식별할 수 있다
* 다른 NAT 와 달리 외부 로컬 주소와 외부 전역 주소가 다를 수 있다
** p444~445

=== IP NAT 호환성 문제와 특수 처리 요구사항

IP 주소가 네트워크 계층과 상위 계층 프로토콜에 의해 실제로 쓰이고 있다 +
-> 다른 여러 헤더와 페이로드의 주소까지 수정할 필요가 있다

NAT 가 네트워크 계층의 IP 수준에서만 동작하지만, 실제로는 더 많은 프로토콜을 인지하고 기능을 수행해야 한다

* TCP 와 UDP 체크섬 재계산: 주소 변환이 일어날 때 재계산 필요
* ICMP 조작 (31장): 특정 ICMP 메시지를 검사, 포함된 주소를 변경할 필요
** ex) Destination Unreachable
* IP 주소를 내장하는 애플리케이션: 데이터 페이로드 안에 IP 주소를 포함
** ex) FTP
*** 오늘날의 많은 NAT 는 FTP 같은걸 지원한다
** 정보를 찾아서 변경할 수 있는 알고리즘을 포함해야 한다
** 단편화된 경우 인식이 어려울 수 있다
* 포트 변환에서의 추가적 문제: 위의 문제가 포트에도 해당, NAT 라우터 부담 가중
* 주소 or 포트 변경의 파급효과: 페이로드 크기가 커지거나 작아지는 변경, TCP 순서 번호 (46장) 도 수정해야 함
* IPSec 에서의 문제: 전체 페이로드 값에 근거한 무결성 검사가 필요하여 IPSec 전송 모드에서는 쓰일 수 없다