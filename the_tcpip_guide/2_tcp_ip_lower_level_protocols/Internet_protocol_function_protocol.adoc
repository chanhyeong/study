= IP 관련 기능 프로토콜

== 28장. IP 네트워크 주소 변환(NAT) 프로토콜

=== IP NAT 개요

IP 주소 비용 증가, 보안 우려 증가 문제를 해결하기 위한 기술 개발

RFC 1631, "The IP Network Address Translator (NAT)"

==== 장점

* 공인 IP 주소 공유: 대량의 호스트가 소수의 공인 IP 주소 공유
* 쉬운 확장: 로컬 네트워크에 새 장비 추가가 쉬움
* 로컬 통제력 강화
* ISP 선택의 유연성: 공인 주소만 변경하면 됨
* 보안 강화, 투명함

==== 단점

* 복잡성
* (클라이언트) 공인 주소 부족으로 인한 문제
* 특정 애플리케이션과의 호환성 문제: FTP 등
* 보안 프로토콜 문제
* 클라이언트 접근 지원 미비
* 성능 감소: 주소 변환, 헤더 체크섬 재계산

=== IP NAT 주소 용어

* 내부 (inside) 주소: 로컬 네트워크의 장비를 가리키는 모든 주소
* 외부 (outside) 주소: 공중 인터넷에 있는 장비를 가리키는 주소
* 로컬 주소: 내부/외부 관계 없이 내부 네트워크의 데이터그램에 나타나는 주소
* 전역 주소: 내부/외부 관계 없이 외부 네트워크의 데이터그램에 나타나는 주소

종합

* 내부 로컬 주소: 로컬 네트워크의 장비 주소
* 내부 전역 주소: 내부 장비를 외부에 표현하는 데 쓰이는 주소
** 서버가 응답을 보낼 때 목적지 주소로 사용할 수 있음
** 일부 상황에서 내부 로컬 주소와 외부 로컬 주소가 동일할 수 있다 (사설 - 사설로 연결된 경우)
* 외부 전역 주소: 인터넷 서버의 외부 전역 주소, 공인 IP
* 외부 로컬 주소: 로컬 네트워크에서 참조하는 외부 장비의 주소

=== 정적 주소 매핑과 동적 주소 매핑

NAT 소프트웨어는 변환 테이블을 관리해야 한다 +
내부 로컬 주소 -> 내부 전역 주소로 매핑하는 정보 포함

==== 정적 매핑

* 장비의 전역 표현과 로컬 표현 사이에 정의된 영구적이고 고정된 관계

==== 동적 매핑

* NAT 라우터에서 필요할 때마다 즉시 생성, 사용이 끝나면 버려짐
* 내부 장비가 내부 전역 주소 풀을 이용할 때

==== 선택

* 정적 매핑: 항상 동일한 공인 주소로 표현되어야 할 장비에 적합
** 특정 장비로의 인바운드 트래픽을 허용하는 데에 쓰일 수도
** 단점: 수동 매핑 정보 입력, 관리. 내부 네트워크에서 IP 공유를 허용하지 않음
* 동적 매핑: 공인 IP 주소 공유를 촉진하기 위해 쓰임
* 모두 사용도 가능
** 특정 장비는 정적, 나머지는 동적
* 동적 매핑의 또다른 방법은 DNS 의 도메인 주소 결정을 사용할 수 있다

=== IP NAT 단방향 (전통적/아웃바운드) 동작

* 최초의 NAT
* 내부에서 외부로 송신되는 데이터그램으로 통신이 시작된다는 가정
** 단방향 (Unidirectional) or outbound NAT
* 순서: p436 그림
** 로컬 장비 -> (출발지/목적지) -> NAT -> (변경 출발지/목적지) -> 서버 -> (목적지/변경 출발지) -> NAT -> (목적지/출발지) -> 로컬 장비
* 하나 이상의 라우터가 존재할 수 있음. 이 경우 라우터들이 동일한 변환 테이블을 사용해야 함

=== IP NAT 양방향 (Two-Way/인바운드) 동작

* directional or inbound
* 전통적 NAT 와, 외부 네트워크에서 시작된 트랜잭션을 모두 처리할 수 있음
* 외부 네트워크의 장비가 내부 네트워크로 보내는 방법 2가지
.. 외부에서 접근해야 하는 내부 네트워크의 서버를 정적 매핑
.. DNS 와 NAT 통합 사용
* 내부 네트워크의 장비가 외부 장비에게 알려지면 트랜잭션이 시작될 수 있다
* 순서: p438 그림, 위와 차이는 양방향만 있음

=== IP NAT 포트 기반 (과부하) 동작

* port-based or overloaded
* 20개의 호스트가 트랜잭션을 진행중일 때 21번째 호스트가 인터넷에 접근을 시도하려 한다면? - 불가능
** 해결하기 위해 상위 계층의 포트를 추가로 사용
* TCP, UDP 의 포트 번호까지 변경
* 포트 번호가 없다면 포트 변환은 수행될 수 없고, PAT 는 제대로 동작하지 않는다

=== IP NAT 중복/2회 NAT 동작

* overlapping or twice
* 내부 네트워크에서 사용하는 주소와 외부 네트워크에서 사용하는 주소가 겹칠 경우, 기존 NAT 로는 어렵다
** 사설 네트워크와 사설 네트워크 간의 연결
** 사설 네트워크에 공인 주소를 부적절하게 할당
** 공인 주소 할당의 유효 기간 만료
* 좀 더 복잡한 형태의 NAT 사용 - 출발지 주소와 목적지 주소를 모두 변경
* 사설 네트워크 + 내부 네트워크 주소 공간과 충돌되는 중복 네트워크를 위한 매핑 생성
** 중복되는 네트워크에 보내는 데이터그램을 유일하게 식별할 수 있다
* 다른 NAT 와 달리 외부 로컬 주소와 외부 전역 주소가 다를 수 있다
** p444~445

=== IP NAT 호환성 문제와 특수 처리 요구사항

IP 주소가 네트워크 계층과 상위 계층 프로토콜에 의해 실제로 쓰이고 있다 +
-> 다른 여러 헤더와 페이로드의 주소까지 수정할 필요가 있다

NAT 가 네트워크 계층의 IP 수준에서만 동작하지만, 실제로는 더 많은 프로토콜을 인지하고 기능을 수행해야 한다

* TCP 와 UDP 체크섬 재계산: 주소 변환이 일어날 때 재계산 필요
* ICMP 조작 (31장): 특정 ICMP 메시지를 검사, 포함된 주소를 변경할 필요
** ex) Destination Unreachable
* IP 주소를 내장하는 애플리케이션: 데이터 페이로드 안에 IP 주소를 포함
** ex) FTP
*** 오늘날의 많은 NAT 는 FTP 같은걸 지원한다
** 정보를 찾아서 변경할 수 있는 알고리즘을 포함해야 한다
** 단편화된 경우 인식이 어려울 수 있다
* 포트 변환에서의 추가적 문제: 위의 문제가 포트에도 해당, NAT 라우터 부담 가중
* 주소 or 포트 변경의 파급효과: 페이로드 크기가 커지거나 작아지는 변경, TCP 순서 번호 (46장) 도 수정해야 함
* IPSec 에서의 문제: 전체 페이로드 값에 근거한 무결성 검사가 필요하여 IPSec 전송 모드에서는 쓰일 수 없다

== 29장. IP Security(IPsec) 프로토콜

=== IPsec 개요, 역사, 표준

보안 문제를 해결하기 위해서 상위 계층에 초점을 맞춘 SSL 등이 생겼지만 +
IP 계층에서 보안을 구현하여 TCP/IP 의 모든 상위 계층 프로토콜이 혜택을 받는게 필요했다

==== IPsec 서비스와 기능 개요

* IP 네트워크를 위한 완전한 보안 솔루션을 제공하는 서비스와 프로토콜 모음
** 서로 결합하여 다양한 유형의 보호를 제공
* 다음과 같은 기능 포함
** 사용자 데이터 암호화
** 메시지 무결성 인증
** replay 공격 등 특정 종류의 보안 공격으로부터 보호
** 장비가 자신의 보안 요구에 맞는 보안 알고리즘과 키를 협상할 수 있게
** 터널 or 전송 모드

=== IPsec 일반 동작, 구성 요소, 프로토콜

* TCP/IP 프로토콜과 애플리케이션이 사용할 수 있도록 IP 계층에서 보안 서비스 제공
* 중간 시스템을 거쳐 가는 보안 경로를 둘 사이에 만든다
** 사용할 프로토콜에 동의
** 인코딩 시 사용할 암호화 알고리즘 결정
** 디코딩 시 쓰이는 키 교환
** 프로토콜, 방법, 키를 이용하여 데이터를 송신할 수 있다

==== 핵심 프로토콜

정보를 인코딩하여 보안을 보장하는 실제 작업 수행

* IPsec Authentication Header (AH)
* Encapsulating Security Payload (ESP)

==== 보조 구성 요소

* 암호화/해싱 알고리즘: AH, ESP 는 암호화에 쓰이는 정확한 방법을 지정하지 않음
** MD5, SHA-1 등의 해싱 알고리즘
* 보안 정책, 보안 연관, 관리 방법: 보안 연관 정보를 교환하기 위한 방법 제공
* 키 교환 프레임워크와 방법: 키를 공유하는 인터넷 키 교환 (IKE) 제공

=== IPsec 구조와 구현 방법

* 종단 호스트 구현: IPsec 을 모든 호스트 장비에 설치, 종단간 보안을 구현
* 라우터 구현: 소수의 라우터만을 변경

IPsec 을 TCP/IP 프로토콜 스택과 결합하는 3가지 방법

==== 통합 구조

* IPv6 는 설계 자체가 지원하지만, IPv4 에서는 현실적으로 실용적이지 않음

==== 스택 삽입 구조 (BITS, bump in the stack)

* IPsec 이 IP <-> 데이터 링크 계층 사이에 별도 계층으로 존재
* 통합 구조에 비해 스택에서 할 일이 늘어난다

==== 라인 삽입 구조 (BITW, bump in the wire)

* IPsec 서비스를 제공하는 하드웨어 장비를 추가
* 네트워크가 복잡해지고 구현 비용이 비싸다

=== IPsec 모드: 전송과 터널

어떤 구현 구조를 네트워크 상의 어떤 위치에 사용할지는 IPsec 이 동작하는 구체적인 방법에 영향을 준다

IPsec 모드의 선택은 IP 데이터그램의 어떤 부분이 보호되는지, 헤더가 어떻게 배열되는지 영향을 준다

==== 전송 모드

* 전송 계층에서 IP 로 내려온 메시지를 보호
* 적절한 헤더가 전송 헤더 앞에 붙고, 그 앞에 IP 헤더가 붙음
* IPsec 헤더는 IP 페이로드에만 적용, IP 헤더에는 적용되지 않는다
* p459 그림

==== 터널 모드

* IP 헤더가 이미 추가된 완전히 캡슐화된 IP 데이터그램을 보호
* p460 그림

==== 전송 모드와 터널 모드 비교

* 전송 모드: IP 헤더, IPsec 헤더, IP 페이로드
* 터널 모드: 새 IP 헤더, IPsec 헤더, 기존 IP 헤더, IP 페이로드

=== IPsec 보안 구성 요소

==== 보안 정책, 보안 연관, 관련 DB

* 보안 정책 (Security Policy): 장비가 수신하는 데이터그램들을 어떻게 처리할지 지시
** 특정 패킷을 IPsec 에서 처리할 필요가 있는지 여부 결정
** 보안 정책 데이터베이스 (SPD) 에 저장되어 있음
* 보안 연관 (Security Association): 장비 간 맺은 특정한 종류의 보안 연결을 설명하는 보안 정보
** 보안 방법을 명시한 계약서
** 보안 연관 데이터베이스 (SAD) 에 저장되어 있음
* 보안 정책이 일반적, 보안 연관은 구체적
* SPD 를 먼저 검사하고 SAD 를 참조할 수 있다

==== 선택자 (selector)

* SA 가 자신이 적용될 데이터그램을 선택하기 위한 규칙 모음
** 규칙 모음 각각을 선택자

==== 보안 연관 트리플과 보안 인자 색인

SA 는 단방향. 장비 A, B 가 있다면 각 장비는 2개씩 SA 를 가지고 있다 +
SA 는 이름이 없고 3개의 인자 모음으로 정의

* 보안 인자 색인 (SPI): 특정 SA 를 유일하기 식별하기 위해 선택된 32비트 숫자. AH or ESP 에 내장
* IP 목적지 주소
* 보안 프로토콜 식별자

=== IPsec 인증 헤더 (AH)

* 데이터그램의 값에 근거하여 계산되는 헤더 추가, 전체 or 일부분에 대한 인증 제공
* 특수 해싱 알고리즘과 출발지/목적지 장비에 알려진 특수 키를 사용
* 계산을 수행한 뒤 무결성 결과값 (ICV, Integrity Check Value) 를 다른 필드와 함께 특수 헤더에 넣어 전송. 목적지에서 동일 계산 수행
* 무결성을 보장하지만 프라이버시는 제공하지 않음

==== AH 데이터그램 위치와 연결

* IPv6: 확장 헤더로 데이터그램에 삽입
* IPv4: IPv4 헤더의 프로토콜 필드에 들어가고, 다음 헤더 필드에 원본 프로토콜 필드를 넣음

=== IPsec 보안 페이로드 캡슐화 (ESP)

* 중간 장비의 변조, 조회를 막음
* 암호화하여 프라이버시 보장

==== ESP 필드

* ESP 헤더: SPI 와 순서 번호를 포함, 암호화된 데이터 앞에 위치
* ESP 트레일러: 암호화된 데이터 뒤에 위치. 패딩과 패딩 길이 필드를 이용해 암호화된 데이터를 32비트 경계에 맞춤
** 일부 암호화 알고리즘은 데이터의 특정 블록 크기를 요구하기 떄문에
* ESP 인증 데이터: ICV 포함, 선택적인 인증 기능 적용 시 사용
** 암호화하고 남은 데이터그램의 나머지 부분을 인증하는데 쓰여서

==== ESP 동작과 필드 사용

. 헤더 계산과 위치
** IPv6: 목적지 옵션 헤더 전, 그 밖의 모든 확장 헤더 뒤
** IPv4: 일반 IPv4 헤더 뒤
. 트레일러 계산과 위치
** 페이로드와 ESP 트레일러 모두 암호화되지만, ESP 헤더는 암호화되지 않는다
** ESP 의 다음 헤더 필드는 헤더가 아닌 트레일러에 나타난다
. ESP 인증 필드 계산과 위치
** 전체 ESP 데이터그램에 대한 계산, 제일 뒤

=== IPsec 인터넷 키 교환 (IKE, Internet Key Exchange)

* 사용할 비밀 정보 교환을 지원하는 프로토콜

==== 개요

* 안전한 통신을 위한 필요 정보 교환
* 3가지 다른 프로토콜 기능을 결합
** ISAKMP (Internet Security Association and Key Management Protocol)
*** 암호화 키와 보안 연관 정보를 교환하기 위한 구조 제공
*** 아래 2개의 키 교환 프로토콜의 기능을 결합한 키 교환 방법의 기초로 사용
** OAKLEY: 다양한 키 교환 모드 정의, 구체적인 방법 제공
** SKEME: 위와 다른 키 교환 방법 설명

==== 동작

* ISAKMP 단계 1: 두 장비가 이후 정보를 어떻게 안전하게 교환할지 동의하는 준비 단계
** ISAKMP 자체를 위한 SA 인 ISAKMP SA 생성
* ISAKMP 단계 2: ISAKMP SA 을 이용하여 기타 보안 프로토콜을 위한 "진짜" SA 생성
* 2개로 나눈 이유는 1단계 뒤에 여러 2단계 협상을 수행할 수 있기 때문