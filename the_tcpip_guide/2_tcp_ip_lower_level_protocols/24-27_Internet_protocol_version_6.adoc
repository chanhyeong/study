= 인터넷 프로토콜 버전 6 (IPv6)

== 24장. IPv6 개요, IPv4 에서 변경된 부분, IPv6 로의 전이

=== IPv6 의 동기와 개요

* 클래스 기반의 주소 할당 방식 때문에 IPv4 주소가 거의 동남
** CIDR, IP NAT 등으로 지연은 시켰음
* 32비트 주소 공간은 인터넷 크기에 비해 턱없이 작다

==== IPv6 표준

* 1998년 발표된 RFC 2460 ~ 2467 로 정의
** 이전, 이후로도 계속 작성되고 있음

==== IPv6 설계 목표

* 더 넓은 주소 공간, 더 효율적인 주소 관리
* 주소 부족을 해결하기 위한 보조 방식의 제거: NAT 나 유사 방식 미사용, 모든 장비가 공인 주소
* 쉬운 TCP/IP 관리
* 현대적인 라우팅 방식
* 더 나은 멀티캐스팅, 보안, 이동성 지원

=== IPv6 의 중요 변경 사항과 추가 사항

* 더 큰 주소 공간
* 계층적 주소 공간
* 유니캐스트 주소의 계층적 할당
** 전 인터넷 상에서 사용할 수 있는 주소를 쉽게 할당할 수 있도록
** 이더넷 MAC 주소와 같은 하드웨어 인터페이스 장치 ID 를 이용하여 IP 주소를 스스로 생성할 수 있게
* 애니캐스트 추가: 가장 가까운 멤버에게 전달
* 자동 구성과 주소 재지정
* 새 데이터그램 포맷
* QoS, 보안 지원
* 단편화와 재조합 과정 개선
* 현대화된 라우팅 지원
* 전이 기능: IPv4/IPv6 전이 기능 제공. 네트워크 호환 및 주소 매핑
* 다른 프로토콜의 변경: ICMPv6, ND 등

=== IPv4 에서 IPv6 로의 전이

==== 전이 방법

* 이중 스택 장비: 라우터와 다른 장비들이 둘 다 구현하여 두 가지 형태의 호스트와 통신할 수 있도록 함
* IPv4/IPv6 변환
** 이중 스택 장비가 IPv6 호스트에서 받은 요청을 IPv4 데이터그램으로 바꿔서 목적지로 전달 가능
** 돌아오는 데이터그램을 바꿔서 IPv6 호스트에게 돌려줄 수 있음
* IPv4 터널링: IPv6 데이터그램을 IPv4 로 캡슐화하여 IPv4 네트워크를 경유하여 전송

하위 호환성만 제공한다

== 25장. IPv6 주소지정 방식

=== IPv6 주소지정 개요: 주소지정 모델, 주소 유형과 주소 크기

==== 특성

IPv4 와 동일한 특성들

* 주소의 핵심 기능: 네트워크 인터페이스 식별, 라우팅
* 네트워크 계층 주소: 데이터링크 계층 주소와는 다름
* 장비당 IP 주소의 수: 일반적으로 유니캐스트 주소 하나
* 주소 해석과 접두사 표현: 접두사 길이로 네트워크 ID 길이
* 사설 주소와 공개 주소

==== 지원하는 주소 유형

* 유니캐스트 주소
* 멀티캐스트 주소
* 애니캐스트 주소: 특정 그룹의 어떤 멤버에게 전달되어야 하지만 모든 멤버에게 전달될 필요는 없다
** 모든 장비가 서로 다른 IP 를 사용해야 하는 불편함을 덜 수 있다 -> 같은 주소를 여러 대의 장비에게 할당하여 애니캐스트 주소를 사용할 수 있음

브로드캐스트 주소는 사라지고, 멀티캐스트 기능을 사용하여 브로드캐스트를 구현

==== 주소 크기와 주소 공간

* 32비트 -> 128비트
** 유연성을 확보하기 위해 사용
** 주소 공간이 모자랄까 걱정하지 않아도 된다

=== IP 주소와 주소 표기법과 접두사 표현

==== 16진 표기법

* 16비트를 단어로 묶고 단어 사이는 콜론(:)으로 분리
* ex) 805B:2D9D:DC28:0000:0000:FC57:D4C8:1FFF
** 연속된 0은 0으로 표기하거나, 압축할 수 있다. 압축은 주소 내 1번만 가능
** 805B:2D9D:DC28:0:0:FC57:D4C8:1FFF
** 805B:2D9D:DC28::FC57:D4C8:1FFF

==== IPv6 혼합 표기법

* IPv6 에 내장된 IPv4 주소는 원래대로 부점 10진 표기법을 사용한다
** ex) 0:0:0:0:0:0:212.200.31.255 -> ::212.200.31.255

==== IPv6 주소 접두사 길이 표시

* IPv4 CIDR 처럼 네트워크 ID 뒤에 호스트 ID 가 따라 온다
** ex) 805B:2D9D:DC28::FC57:D4C8:1FFF/48

=== IP 주소 공간 할당

* IPv4 와 마찬가지로 라우팅은 가장 중요한 고려 사항
* 주소 중 첫 번째 3~10 비트를 사용하여 주소 공간의 특정 영역이 다른 영역보다 더 많은 주소를 가지게 한다
** p382 표 25-1
*** 001 은 유니캐스트, 000 은 예약 주소 불록, 111 은 로컬 하위 블록 & 멀티캐스트 주소
**** 3비트 공간 중 나머지 5개는 비어 있다

=== IPv6 전역 유니캐스트 주소 포맷

==== 유니캐스트 주소 블록 구조

인터넷의 전체적인 토폴리지를 반영

* 다양한 계층에서 주소 블록을 수비게 할당할 수 있도록
* 라우터가 계층 구조를 자동으로 IP 네트워크 주소에서 반영
* ISP 와 같은 기관이 주소 블록을 나누어 줄 수 있도록 유연성 강화
* IP 서브넷과 같이 내부 내트워크에 맞추어 주소 블록을 나눌 수 있도록 유연성 강화
* IP 주소에 의미를 더 부여

==== 유니캐스트 주소 공간을 나누는 일반적인 방법

[cols="1,1,3"]
|===
|필드명 |크기 |설명

|접두사 |n |전역 라우팅 접두사: 네트워크 ID or 접두사

|서브넷 ID |m |서브넷 식별자

|인터페이스 ID |128-n-m |인터페이스 식별자

|===

==== 유니캐스트 주소 공간의 IPv6 구현

위는 이론적이고, IEEE EUI-64 포맷에 따라 아래와 같이 구성

[cols="1,1,3"]
|===
|필드명 |크기 |설명

|접두사 |48 |전역 라우팅 접두사: 네트워크 ID or 접두사

|서브넷 ID |16 |서브넷 식별자

|인터페이스 ID |64 |인터페이스 식별자

|===

* 최종 사이트는 접두사의 길이가 48비트인 IPv6 네트워크를 할당 받음
* 서브넷 ID 의 16비트를 이용하여 서브넷을 만들 수 있다

==== 원본 전역 라우팅 접두사 분할 방식: 집합자 (Aggregator)

전체 48비트 중 45비트로 전역 라우팅 접두사를 나눌 수 있다 (3비트는 001 로 고정)

* 최상위 집합자 (TLA, Top-Level Aggregators)
* 차상위 집합자 (NLA, Next-Level Aggregators)
* 이 개념은 2003년부터 제거했다. 지식을 위해 남겨둠 - 유연성이 떨어지기 때문

=== IPv6 인터페이스 식별자와 물리 주소 매핑

* IP 유니캐스트 주소와 물리 계층 주소 간을 매핑할 수 있는 방법
** 데이터링크 계층의 하드웨어 주소를 인터페이스 ID 로 사용할 수 있음
** 보통은 48비트: IEEE 802 MAC
* 64비트 확장 유일 식별자 (EUI-64, 64-bit extended unique identifier)
** OUI (기관 유일 식별자) 는 20비트로 동일, 장비 식별자를 40비트로 확장
* '수정 EUI-64' 는 IPv6 인터페이스 ID 로 쓰인다
.. OUI 24비트를 가져와서 가장 왼쪽 24비트에 쓰고, 나머지 24비트를 가장 오른쪽 24비트에 쓴다
.. 중간 부분 16비트에 1로 채워 FFFE 로 만든다
.. 전역/로컬 비트 (왼쪽 7번째 비트) 를 1로 바꾼다 -> 수정 EUI-64 인터페이스 ID
* 유일한 단점: 하드웨어가 바뀌면 IPv6 주소도 바뀐다

=== 특별한 IPv6 주소: 예약, 사설, 미지정, 루프백

==== 특별 주소 유형

* 예약 주소: 미래를 위해 예약된 공간. 0000 0000
* 사설/미등록/라우팅 불가 주소: 특정 회사의 네트워크 밖으로 나가지 않는다. 1111 1110 1
* 루프백 주소: ::1
* 미지정 주소: 모두 0이면 자기 자신.

==== 사설 주소 유형 범위

로컬 사용 주소 - 같은 지역 내 장비들끼리만 통신하기 위해 사용 +
ND 프로토콜 사용하여 주위 장비를 탐색할 때 활용

* 사이트 로컬 주소: 공개 접두사가 없으며 기관 내에서 사용
** 10번째 비트가 1 - 1111 1110 11
* 링크 로컬 주소: 물리적으로 연결된 링크 내에서만 사용. 특정 물리 네트워크 내부에서 통신하기 위해 사용
** 10번째 비트가 0 - 1111 1110 10

=== IPv4 주소 내장

IPv4/IPv6 호환 기법을 지원하기 위해서 내장

* IPv4 호환 IPv6 주소: IPv6 기능을 가지는 장비를 위한 주소. 앞 96 비트를 전부 0으로
** ex) ::101.45.75.219
* IPv6 매핑된 IPv4 주소: 오로지 IPv4 만을 지원하는 장비를 위해 사용하는 주소. 80 비트 0 다음 16 비트 1
** ex) ::FFFF:222.1.41.90

=== IPv6 멀티캐스트와 애니캐스트 주소지정

==== 멀티캐스트 주소

* IPv6 멀티캐스트 주소는 멀티캐스트 블록에서 할당
* 1111 1111 (FF) 로 시작하는 주소는 멀티캐스트 주소

[cols="1,1"]
|===
|필드명 |크기

|(지정자) |8

|플래그 |4

|범위 ID |4

|그룹 ID |112

|===

* 범위: 범위를 지정하면 라우터가 멀티캐스트 주소만 보고 얼마나 전달해야 하는지 결정할 수 있다
* 잘 알려진 멀티캐스트 주소
** 그룹 ID 가 전부 0: 모두 예약되어 있다
** 그룹 ID 1: 1 이면 모든 노드에 멀티캐스트
** 그룹 ID 2: 수신자 영역으로 결정된 곳에 있는 모든 라우터에게 전달
* 요청 노드 멀티캐스트 주소: 유니캐스트 주소를 특수하게 매핑하여 생성
** T 플래그 0 (영구적으로 할당 or 잘 알려진 주소), 범위 ID 2 (링크 로컬) -> FF02
** 79개 0 + 1 = 80
** 다음 8비트 1
** 나머지 24는 유니캐스트 아래 24개 비트
** = FF02:0:0:0:0:1:FF
** 다른 장비가 이 노드와 통신하려 할 때 사용

==== 애니캐스트 주소

* 데이터를 그룹 멤버 중 가장 가까운 멤버에게 보내라는 명령 주소
* 어떤 서버나 라우터에서 받던지 상관 없을 때 사용
* 부하를 적절히 나눌 수 있다
* 특별한 주소 지정 방식이 없다 - 유니캐스트와 동일하다
* 라우터만이 애니캐스트 주소를 사용한다

=== IPv6 자동 구성과 주소 재지정

장비가 독립적으로 스스로를 구성할 수 있는 기능

==== 상태 비유지형 자동 구성

링크 로컬 주소, 멀티캐스트, ND 프로토콜, 데이터링크 계층 주소를 사용하여 인터페이스 ID 를 생성할 수 있다는 점을 사용 +
\== 장비가 자신의 네트워크 특징을 알아내고 사용할 임시 주소를 생성할 수 있다

. 링크 로컬 주소 생성: 1111 1111 10 + 54비트 0 + (수정 EUI-64 or 토큰)
. 링크 로컬 주소 고유성 검사: 로컬 네트워크에 이미 있는지 검사
** ND 프로토콜로 주변 정보 요청 메시지 전송
** 주변 정보 전달을 받게 되면 새 주소 생성 or 다른 방법을 찾음
. 링크 로컬 주소 할당: 2가 통과하면 로컬 주소에서만 고유한 주소를 자신에게 할당
. 라우터 접촉: 라우터 광고를 듣거나 특정 라우터 요청을 보내 라우터에게 정보 요구
. 라우터 지시: 자동 구성 진행 방향 지시
** DHCP 서버 주소를 알려주거나 or 전역 인터넷 주소를 결정하는 방법 제시
. 전역 주소 구성
** 상태 비유지형 자동 구성을 적용하는 네트워크라면 스스로 고유한 자신의 주소 생성
** 라우터가 알려준 네트워크 접두사를 통해 형성

==== 장비 주소 재지정

* 자동 구성과 관련
* IP 주소를 일정 시간 동안 대여하는 방식. DHCP 와 유사한 프로토콜을 통해 구현
* 자동 구성이 수행될 때 라우터가 네트워크 접두사의 유통기한을 명시하도록 한다 - 35장에서 설명

== 26장. IPv6 데이터그램 캡슐화와 포맷

=== IPv6 데이터그램 개요와 일반적인 구조

헤더에서 꼭 필요한 필드만 남기고 나머지는 모두 삭제했다

* 다중 헤더 구조: 기본 헤더 (40바이트) + 확장 헤더 - 추가 정보는 확장 헤더에서만
* 효율적인 헤더 포맷: 기본 헤더의 크기를 줄이기 위해 필요한 필드만 남기고 확장 헤더로 이동
* 필드명 개명, 유연성 증가
* 체크섬 계산 제거: 데이터그램이 지나갈 때마다 체크섬 계산을 위해 호스트와 라우터가 소모했던 시간 줄임
* QoS 강화: Flow Label 필드 추가

=== IPv6 데이터그램 기본 헤더 포맷

주소, 데이터그램 처리와 라우팅에 필요한 제어 정보를 가진다

[cols="1,1,3"]
|===
|필드명 |크기 |설명

|버전 |1/2 |IP 버전, 0110 으로 고정

|트래픽 클래스 |1 |서비스 유형 (TOS) 대체

|흐름 라벨 |2 1/2 |실시간 데이터그램 전달과 QoS 특성 제공을 위함

|페이로드 길이 |2 |페이로드의 길이만 (+ 확장 헤더 길이)

|다음 헤더 |1 |프로토콜 필드 대체, 확장 헤더가 있다면 식별하기 위함

|홉 한계 |1 |TTL 필드 개명

|출발지 주소 |16 |

|목적지 주소 |16 |

|===

==== 다음 헤더 필드

* 첫 번째 확장 헤더의 식별자가 다음 헤더의 필드값 -> 그 다음 헤더를 재귀로 계속 가리키고
** 마지막 헤더는 페이로드에 실린 상위 계층 프로토콜을 가리킴
* 다음 헤더에 들어가는 값 - p406 표

==== 기본 헤더 차이점

* 헤더 체크섬 필드 미사용 - 상위 계층의 오류 검사와 데이터 링크 계층의 CRC 와 겹쳐서 불필요
* IPv4 에서는 선택사항을 기본 헤더의 일부로 생각했지만, IPv6 에서는 확장 헤더에서 지원

=== IPv6 데이터그램 확장 헤더

* 특별한 목적을 위해서만 사용되는 필드 정의, 필요할 때만 데이터그램에 삽입

==== 다음 헤더 필드를 사용한 IPv6 헤더 사슬

* 모든 확장 헤더는 공통적으로 다음 헤더 필드를 가진다
* 각 헤더 유형 구조 중 가장 마지막 필드는 다음 헤더아다 (가장 처음 아닌가?)

==== IPv6 확장 헤더 요약

* p409 표
* 다음 헤더가 없을 때 dummy (59) -> 뒤에 아무 것도 없다

==== 확장 헤더 순서

* 각 확장 헤더는 단 한 번만 나올 수 있다 (예외 있음)
* 최종 수신자만이 확장 헤더를 검사할 수 있다 (예외 있음)
. 홉 간 선택사항
. 목적지 선택 사항
. 라우팅
. 단편화
. 인증 헤더
. 보안 페이로드 캡슐화
. 목적지 선택사항
* 목적지 선택사항은 두 번 나올 수 있다 & 소스 라우팅에 명시한 장비들에서 검사할 수도 있다 (2번 순서)
* 모든 중간 노드가 검사해야 하는 헤더는 홉간 선택사항 확장 헤더이다
* 모든 확장 헤더는 8바이트 배수이다

=== IPv6 데이터그램 선택사항

IPv6 선택사항은 확장 헤더의 부족한 부분을 보충한다

* 목적지 선택사항: 최종 목적지에서 읽어야 하는
* 홉 간 선택사항: 경로 상 모든 장비가 읽어야 하는
* p414 표

== 27장. IPv6 데이터그램 크기, 단편화, 재조합과 라우팅

=== IPv6 데이터그램 크기와 단편화

링크의 최대 전송 단위(MTU) 는 물리 네트워크가 전달할 수 있는 최대 데이터그램 크기

* 기본 MTU 크기 증가: IPv4 는 576바이트, IPv6 는 1,280 바이트
** 단편화가 자주 일어나지 않는다
* 경로 내 단편화 과정 제거: 출발지 노드만 단편화 가능, 목적지 노드만 재조합 가능
* MTU 오류 크기 피드백: 크기가 큰 데이터그램은 버리고 출발지 노드에게 너무 크다고 알림
* 경로 MTU 발견: 사용할 크기를 정할 수 있음
* 헤더 내 단편화 필드의 이동: 확장 헤더로

=== IPv6 출발지 단편화 법칙의 의미

IPv4 에서는 라우팅에 드는 비용이 너무 컸다 +
라우터가 단편화가 아니라 전달에만 전념하면 속도가 훨씬 빠를 것

출발지에서는 어떻게 적당한 크기를 알 수 있는가?

* 기본 MTU 사용: 1,280 바이트
* 경로 MTU 발견 사용: 시험 메시지 전송으로 전체 경로의 최소 MTU 크기를 결정
** 피드백 기법을 사용하여 찾을 수 있음
** 보낼 수 있는 최대 크기로 전송 -> 초과 메시지가 돌아오면 작은 크기로 다시 전송

출발지만 단편화가 가능하면 경로가 바뀔 경우 MTU 크기가 바뀔 수 있다는 점이 문제 +
경로를 주기적으로 추적하여 다시 검사해야 한다

=== IPv6 단편화 과정

* 단편화 불가 부분: 기본 헤더 + 일부 확장 헤더 (홉 간 선택사항, 목적지 선택사항, 라우팅)
* 단편화 가능 부분: 실제 데이터 부분 + 그 외 확장 헤더