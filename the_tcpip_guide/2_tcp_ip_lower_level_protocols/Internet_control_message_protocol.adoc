= IP 지원 프로토콜

== 31장. ICMP 개념과 일반 동작

=== ICMP 개요, 역사, 버전, 표준

* 네트워킹 동작을 지시해줄 정보를 교환해야하고, 테스트와 진단을 수행할 필요가 있다
** ICMP 를 통해 제공하고, ICMP 메시지를 통해 지원한다
* Internet Control Message Protocol (RFC 792)
** 모든 IP 모듈에 구현되어야 하는 IP 의 필수 요소
* 확장 가능한 범용 메시징 시스템을 정의한다
** 기타 프로토콜도 ICMP 에서 사용할 수 있는 메시지 유형을 정의할 수 있다
** (주소 마스크 요청, 경로 추적, 라우터 광고 등)

=== ICMP 일반 동작

==== ICMP 메시지 전달 서비스

* ICMP 자체는 서로 다른 ICMP 메시지가 어떻게 쓰이는지 정의하지 않음
* 메시지의 실제 용도는 메시지를 이용하는 프로토콜에 의해 정의
* 일반적으로 **소프트웨어의 특정 구성 요소가 ICMP 메시지를 생성할 필요가 있는지 상황을 탐지하는 방식으로 동작**
* 라우터와 일반 호스트 모두에서 송신할 수 있다

==== ICMP 에러 보고는 데이터그램 원본으로만 송신 가능

* 에러 발생 시 최초 출발지로만 알릴 수 있다
** 메시지에는 최초 출발지만 있기 때문
** 중간 라우터에서 문제가 생겨도 해당 라우터로 보낼 수 없다
* 출발지에서는 경로를 바꾸거나 에러 보고서를 생성할 수 있다

=== ICMP 메시지 클래스, 유형 코드

==== 메시지 클래스

* 오류 메시지: 에러가 발생했다는 것을 출발지 장비에게 알릴 때
* 정보 제공(요청) 메시지: 정보 교환, 기능 구현, 테스트 수행에 사용
** 애플리케이션에서 생성 or 정보 제공을 위해 주기적으로 생성

==== 메시지 유형

* 고유한 메시지 유형값을 갖는다, 8비트
* ICMPv4 에서는 유형값만 가지고 메시지의 클래스를 알 수 없다

==== 메시지 코드

* 메시지 유형: 일반적인 목적. 메시지 코드: 세부적으로 메시지 분류

==== 요약

p513 ~ p514 표

=== ICMP 메시지 생성과 처리 관습, 규칙

* ICMP 메시지는 사용자 데이터를 담지 않아서 대역폭 낭비는 극히 일부이다
* 필요한 경우에만 ICMP 메시지를 보내고, 생성되는 상황을 신중하게 제어하려고 한다
* 여러 RFC 에서 ICMP 메시지 생성과 처리법을 설명한 관습, 규칙 모음이 존재한다

==== ICMP 메시지 응답의 한계

문제는 주로 오류 메시지에서 일어난다 +
생성 루프가 발생할 수도 있다

오류 메시지는 다음에 대한 응답으로 생성되면 안된다

* ICMP 오류 메시지
* 브로드캐스트 or 멀티캐스트 데이터그램
** ICMPv6 패킷 크기 초과 메시지는 멀티캐스트 주소로 송신될 수 있음
* 데이터그램 단편
* 유니캐스트가 아닌 출발지 주소를 가지고 있는 데이터그램

==== ICMP 메시지 처리 관습

* IPv6 에서는 메시지 클래스를 유형값을 통해 파악할 수 있다
** 알려지지 않은 유형 값의 오류 메시지는 상위 계층으로 전달되어야 한다
** 알려지지 않은 유형 값의 정보 메시지는 버려진다
* 메시지 유형 처리 방향을 지시하기 위한 구체적인 규칙이 존재한다
* ICMP 메시지를 수신 장비가 반드시 처리해야 하는 것은 아니다
** 광고 같은건 예외

=== ICMP 일반 메시지 포맷과 데이터 캡슐화

메시지 유형에 따라 담고 있는 정보의 유형도 다르지만, 일부분은 동일하다

==== ICMP 일반 메시지 포맷

모든 ICMP 메시지에서 동일한 크기와 의미를 가지는 3개의 필드로 구성 (v4, v6 동일)

[cols="1,1,3"]
|===
|필드명 |크기 |설명

|유형 |1 |메시지 유형 식별

|코드 |1 |하위 유형 식별

|체크섬 |2 |IP 헤더 체크섬과 유사한 방법으로 계산. 에러 탐지 기능 제공

|본문 |가변 |

|===

==== ICMP 오류 메시지에 포함된 원본 데이터그램

오류 메시지 본문에는 원본 데이터그램의 일부분을 포함한다

각 오류 메시지는 버전에 따라 아래와 같음

* ICMPv4: IP 헤더 전체 + 페이로드의 처음 8바이트 (캡슐화된 상위 계층 헤더)
* ICMPv6: 최소 IPv6 MTU 인 1,280 바이트를 초과하지 않는 범위에서 가능한 많은 양의 데이터그램 포함

==== ICMP 데이터 캡슐화

* IP 데이터그램으로 캡슐화