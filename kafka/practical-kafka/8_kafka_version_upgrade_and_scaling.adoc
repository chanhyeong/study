= 8. 카프카 버전 업그레이드와 확장

클러스터에 미치는 영향을 최소로 줄이고, 순서와 주의사항 등

== 버전 업그레이드 준비

* 사용 중 버전 확인
** 릴리즈 노트를 보며 문제가 될 만한 부분이 없는지 확인
** 메시지의 포맷 변경, 브로커 디폴트 값 변화, 명령어 지원 종료, JMX 메트릭 변화 등
* 사용 중 버전 과 업그레이드 대상 버전의 차이점 파악

== 롤링 업그레이드

.server.properties
[source]
----
inter.broker.protocol.version=2.1
log.message.foramt.version=2.1
----

* 한 대씩 stop -> start 하더라도 replication 기능을 통해 서비스는 장애 없이 정상 작동
* 서버 간 통신 시 버전을 구 버전으로 고정했으므로 호환
** 업그레이드 완료 시 제거 후 1대 씩 restart -> 기본값이 적용됨

=== 주의 사항

* 개발용 카프카에서 먼저 버전 업그레이드 수행해보기
* 카프카의 사용량이 적은 시간대를 골라 업그레이드 작업 실시하는 것을 권장
* `acks=1` producer 의 경우 극히 일부 메시지가 손실될 수 있음

== 확장

새로운 브로커를 추가한다고 자동으로 리밸런싱이 되지 않는다

=== 부하 분산

* `kafka-reassign-partions.sh` 를 이용하여 파티션 이동 (273~277p)

=== 주의 사항

* 사용량이 낮은 시간에 진행
* 메시지 용량 최적화 검토 (7일 -> 1일)
* 작업 시 동시에 여러 개가 아닌 하나 씩 진행 (replication 부하 방지)
