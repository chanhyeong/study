= 8. 통합 테스트를 하는 이유

== 통합 테스트는 무엇인가?

=== 역할

단위 테스트가 충족하는 3가지 요구 사항 - 단일 동작 검증 & 빠르게 수행 & 다른 테스트와 별도로 처리

3가지 중 하나라도 충족하지 못하는 테스트는 통합 테스트 범주에 속한다 +
단위 테스트가 아닌 모든 테스트 - 통합 테스트에 해당 +

앞에서 나온 "컨트롤러" 에 해당하는 코드를 다룬다 - 프로세스 외부 의존성과 도메인을 연결하는 코드를 확인

=== 테스트 피라미드

통합 테스트가 프로세스 외부 의존성에 직접 작동하면 느려지고 유지비가 많이 든다

코드를 더 많이 거치므로 회귀 방지가 단위 테스트보다 우수하다 +
제품 코드와 결합도가 낮아서 리팩토링 내성 우수

단위 테스트로 가능한 한 많은 비즈니스 시나리오 예외 상황 (오류가 발생하는 경우) 확인 +
통합 테스트로 happy path (시나리오의 성공적인 실행) 와 단위 테스트가 다루지 못하는 edge case 를 다룸

중요한 통합 테스트가 비즈니스 시나리오 당 1~2 개 있으면 시스템 전체의 정확도를 보장할 수 있다 (피라미드 모양)

단순 애플리케이션은 단위 테스트와 통합 테스트의 수가 같다 (직사각형 모양)

=== 통합 테스트와 빠른 실패

통합 테스트로 happy path 와 edge case 를 다루는 지침

통합 테스트에서 프로세스 외부 의존성과의 상호 작용을 모두 확인하려면, 가장 긴 주요 흐름을 선택 +
없으면 그 만큼의 통합 테스트를 추가로 작성

TIP: 좋지 않은 테스트를 작성하는 것보다는 테스트를 작성하지 않는 것이 좋다. 가치가 별로 없는 테스트는 좋지 않은 테스트다

빠른 실패 원칙 (Fast Fail principle): 버그를 빨리 나타나게 하는 것, 통합 테스트에서 할 수 있는 대안

.빠른 실패 원칙
****
예기치 않은 오류가 발생하자마자 현재 연산을 중단하는 것

* 피드백 루프 단축: 빠르게 버그를 발견하려 쉽게 해결 (운영보단 개발 단계에서 더 빠르게 고칠 수 있다)
* 지속성 상태 보호: 빨리 실패하면 손상이 확산되는 것을 막을 수 있다

예외를 던져서 현재 연산 중지 - 프로그램 흐름 중단, 로그를 남기고 종료하거나 재시작

Precondition 은 빠른 실패 원칙의 예다
****

== 어떤 프로세스 외부 의존성을 직접 테스트해야 하는가?

실제 프로세스 외부 의존성 사용 or 해당 의존성을 mock 으로 대체하기

=== 프로세스 외부 의존성의 두 가지 유형

* *관리 의존성* (전체 제어 가능): 애플리케이션을 통해서만 접근 가능, 외부에서 볼 수 없음 (DB)
** 구현 세부 사항
** 시스템의 최종 상태가 중요, 실제를 사용하면 외부 클라이언트 관점에서 최종 상태 확인 가능, DB 리팩토링에도 도움
* *비관리 의존성* (전체 제어 불가능): 외부에서 상호 작용을 볼 수 있음, 애플리케이션에서 볼 수 있는 부작용 발생 (SMTP, 메시지 버스 등)
** 식별할 수 있는 동작
** 통신 패턴을 유지하여 하위 호환성을 지켜야 한다 - mock 으로 보장

image::https://drek4537l1klr.cloudfront.net/khorikov/Figures/08fig04_alt.jpg[]

NOTE: 관리 의존성은 실제 인스턴스를 사용, 비관리 의존성은 mock 으로 대체

=== 관리 의존성, 비관리 의존성 둘 다에 해당하는 프로세스 외부 의존성 다루기

다른 애플리케이션이 접근할 수 있는 데이터베이스

다른 애플리케이션에서 볼 수 있는 테이블을 비관리 의존성으로 취급 (mock 사용) +
나머지는 관리 의존성으로 처리 & 상호 작용을 검증하지 말고 최종 상태를 확인

=== 통합 테스트에서 실제 DB 를 사용할 수 없으면 어떻게?

*DB 를 그대로 테스트할 수 없으면 통합 테스트를 아예 작성하지 말고 도메인 모델의 단위 테스트에만 집중해라*

통합 테스트에서 관리 의존성을 실제 버전으로 사용할 수 없는 경우 (레거시 DB, 보안 정책, 테스트 DB 설정 및 유지 비용 등) +
단순히 mock 으로 하면 통합 테스트의 리팩토링 내성이 저하된다 -> 단순히 메소드 호출 검증 밖에 되지 않음

== 예제

7장의 예시 재활용

=== 어떤 시나리오를 테스트?

가장 긴 주요 흐름 = 프로세스 외부 의존성을 거치는 것

기업 이메일에서 일반 이메일로 변경하는 것 - 부작용이 가장 많다 (DB 에서 사용자, 회사 모두 업데이트, 메시지 버스로 메시지 발송)

`public void Changing_email_from_corporate_to_non_corporate()`

=== DB 와 Message Bus 분류

직접 테스트할 대상과 mock 으로 대체할 대상 결정

=== end-to-end 테스트?

end-to-end 는 외부 클라이언트를 모방하므로, 어떤 것도 mock 으로 대체되지 않음 (p285 8.7)+
통합 테스트는 비관리 의존성을 mock 으로 대체 (p285 8.8)

배포 후 프로젝트의 상태 점검을 위해 1~2개의 중요한 end-to-end 테스트를 작성할 수 있다 +
모든 프로세스 외부 의존성과 올바르게 통신할 수 있도록 함 (메시지 버스 직접 확인, DB 상태는 애플리케이션에서 검증)